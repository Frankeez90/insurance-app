import streamlit as st
import pandas as pd
import plotly.express as px
from datetime import datetime

# --- 1. è¯­è¨€åŒ…é…ç½® (Language Config) ---
TRANSLATIONS = {
    "cn": {
        "title": "ðŸ›¡ï¸ å®¢æˆ·ä¿å•å¹´åº¦æ£€è§†æŠ¥å‘Š",
        "sidebar_title": "ðŸ”§ å·¥å…·ç®±",
        "lang_select": "é€‰æ‹©è¯­è¨€ (Language)",
        "client_profile": "ðŸ‘¤ å®¢æˆ·æ¡£æ¡ˆ",
        "client_name": "å®¢æˆ·å§“å",
        "client_age": "å¹´é¾„",
        "add_policy_header": "âž• æ·»åŠ ä¿å•",
        "policy_name": "ä¿å•åç§°/è®¡åˆ’",
        "policy_company": "ä¿é™©å…¬å¸",
        "benefits_label": "ðŸ›¡ï¸ é€‰æ‹©ä¿å•åŒ…å«çš„åˆ©ç›Š (å¯å¤šé€‰)",
        "benefits_options": [
            "äººå¯¿ (Life)",
            "åŒ»è¯å¡ (Medical Card)",
            "36ç§ä¸¥é‡ç–¾ç—… (36 CI)",
            "106ç§ä¸¥é‡ç–¾ç—…-åˆæœŸ (106 CI)",
            "157ç§ä¸¥é‡ç–¾ç—…-åˆæœŸ (157 CI)",
            "ä¸ªäººæ„å¤– (PA)",
            "ä¿è´¹è±å… (Waiver)"
        ],
        "premium": "å¹´ç¼´ä¿è´¹ (RM)",
        "coverage": "äººå¯¿/é‡ç–¾ä¿é¢ (RM)",
        "medical_limit": "åŒ»è¯å¡å¹´é™é¢ (RM) (å¦‚æœ‰)",
        "sustainability": "ä¿å•æŒä¹…æ€§ (å¯ç»´æŒè‡³å¤šå°‘å²)",
        "max_age": "æœ€é«˜ç»­ä¿å¹´é¾„ (è‡³å¤šå°‘å²)",
        "remarks": "å¤‡æ³¨ (å¦‚: Cash Value / ç¼ºå£)",
        "add_btn": "ðŸ“¥ æ·»åŠ æ­¤ä¿å•",
        "clear_btn": "ðŸ—‘ï¸ æ¸…ç©ºåˆ—è¡¨",
        "report_header": "ðŸ“Š å¹´åº¦æ£€è§†åˆ†æž",
        "total_premium": "å¹´åº¦æ€»ä¿è´¹æ”¯å‡º",
        "total_coverage": "æ€»äººå¯¿/é‡ç–¾ä¿éšœ",
        "table_header": "ðŸ”Ž çŽ°æœ‰ä¿å•æ˜Žç»†",
        "chart_title": "å„ä¿å•æŠ•å…¥ vs ä¿éšœåˆ†æž",
        "download_header": "ðŸ’¾ ä¿å­˜/ä¸‹è½½",
        "download_btn": "ðŸ“¥ ä¸‹è½½æ£€è§†æŠ¥å‘Š (Excel/CSV)",
        "footer": "ä¸“ä¸šé¡¾é—®å¹´åº¦æœåŠ¡ | Generated by E&S Agency Tool",
        "empty_msg": "ðŸ‘ˆ è¯·åœ¨å·¦ä¾§ä¾§è¾¹æ æ·»åŠ ä¿å•ä»¥ç”ŸæˆæŠ¥å‘Šã€‚"
    },
    "en": {
        "title": "ðŸ›¡ï¸ Annual Policy Review Report",
        "sidebar_title": "ðŸ”§ Toolbox",
        "lang_select": "Language",
        "client_profile": "ðŸ‘¤ Client Profile",
        "client_name": "Client Name",
        "client_age": "Age",
        "add_policy_header": "âž• Add Policy",
        "policy_name": "Policy Name/Plan",
        "policy_company": "Company",
        "benefits_label": "ðŸ›¡ï¸ Select Benefits Included (Multi-select)",
        "benefits_options": [
            "Life",
            "Medical Card",
            "36 Critical Illnesses",
            "106 CI (Early Payout)",
            "157 CI (Early Payout)",
            "Personal Accident",
            "Premium Waiver"
        ],
        "premium": "Annual Premium (RM)",
        "coverage": "Life/CI Sum Assured (RM)",
        "medical_limit": "Medical Annual Limit (RM)",
        "sustainability": "Sustainability (Up to Age)",
        "max_age": "Max Coverage Age",
        "remarks": "Remarks (e.g. Cash Value)",
        "add_btn": "ðŸ“¥ Add to List",
        "clear_btn": "ðŸ—‘ï¸ Clear All",
        "report_header": "ðŸ“Š Review Analysis",
        "total_premium": "Total Annual Premium",
        "total_coverage": "Total Life/CI Coverage",
        "table_header": "ðŸ”Ž Policy Details",
        "chart_title": "Premium vs Coverage Analysis",
        "download_header": "ðŸ’¾ Save Report",
        "download_btn": "ðŸ“¥ Download Report (Excel/CSV)",
        "footer": "Professional Annual Review | Generated by E&S Agency Tool",
        "empty_msg": "ðŸ‘ˆ Please add policies from the sidebar to generate report."
    }
}

st.set_page_config(page_title="Policy Review Tool", page_icon="ðŸ“", layout="wide")

# --- 2. åˆå§‹åŒ– Session State ---
if 'policies' not in st.session_state:
    st.session_state.policies = []

# --- 3. ä¾§è¾¹æ ï¼šè¾“å…¥åŒº ---
with st.sidebar:
    lang_code = st.radio("Language / è¯­è¨€", ["ä¸­æ–‡", "English"], horizontal=True)
    lang = "cn" if lang_code == "ä¸­æ–‡" else "en"
    t = TRANSLATIONS[lang]

    st.title(t["sidebar_title"])
    
    # å®¢æˆ·èµ„æ–™
    st.header(t["client_profile"])
    c_name = st.text_input(t["client_name"], placeholder="Mr. / Ms.")
    c_age = st.number_input(t["client_age"], min_value=0, max_value=100, value=30)
    
    st.markdown("---")
    
    # æ·»åŠ ä¿å•è¡¨å•
    st.header(t["add_policy_header"])
    
    with st.form("add_policy_form", clear_on_submit=True):
        p_name = st.text_input(t["policy_name"])
        p_company = st.selectbox(t["policy_company"], ["Allianz", "AIA", "Prudential", "Great Eastern", "Zurich", "Hong Leong", "Takaful", "Other"])
        
        # --- æ–°å¢žï¼šåˆ©ç›Šå¤šé€‰æ¡† ---
        p_benefits = st.multiselect(t["benefits_label"], t["benefits_options"])
        
        col_sb1, col_sb2 = st.columns(2)
        with col_sb1:
            p_prem = st.number_input(t["premium"], min_value=0.0, step=100.0)
            # å¦‚æžœé€‰äº†åŒ»è¯å¡ï¼Œæé†’è¾“å…¥é™é¢ï¼Œå¦åˆ™é€šå¸¸æ˜¯0
            p_med_limit = st.number_input(t["medical_limit"], min_value=0.0, step=10000.0, help="Annual Limit")
        with col_sb2:
            p_cov = st.number_input(t["coverage"], min_value=0.0, step=1000.0)
            p_sust = st.number_input(t["sustainability"], min_value=0, max_value=100)
            
        p_max_age = st.number_input(t["max_age"], min_value=0, max_value=100, value=80)
        p_rem = st.text_area(t["remarks"], height=60)
        
        submitted = st.form_submit_button(t["add_btn"])
        
        if submitted:
            if p_name:
                # å°†é€‰ä¸­çš„åˆ©ç›Šåˆ—è¡¨è½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ "äººå¯¿, åŒ»è¯å¡"
                benefits_str = ", ".join(p_benefits)
                
                st.session_state.policies.append({
                    t["policy_name"]: p_name,
                    t["policy_company"]: p_company,
                    "Benefits / åˆ©ç›Š": benefits_str, # æ–°åˆ—å
                    t["premium"]: p_prem,
                    t["coverage"]: p_cov,
                    t["medical_limit"]: p_med_limit, # æ–°å¢žåŒ»è¯å¡é™é¢åˆ—
                    t["sustainability"]: p_sust if p_sust > 0 else "-",
                    t["max_age"]: p_max_age,
                    t["remarks"]: p_rem
                })
                st.success("âœ… Added!")
            else:
                st.error("Please enter policy name.")

    # æ¸…ç©ºæŒ‰é’®
    if len(st.session_state.policies) > 0:
        if st.button(t["clear_btn"]):
            st.session_state.policies = []
            st.rerun()

# --- 4. ä¸»ç•Œé¢ï¼šæŠ¥å‘Šæ˜¾ç¤º ---
st.title(f"{t['title']}")
if c_name:
    st.subheader(f"{t['client_profile']}: {c_name} ({c_age})")
st.markdown(f"Date: {datetime.now().strftime('%Y-%m-%d')}")
st.markdown("---")

if len(st.session_state.policies) == 0:
    st.info(t["empty_msg"])

else:
    df = pd.DataFrame(st.session_state.policies)
    
    # é¡¶éƒ¨å…³é”®æŒ‡æ ‡
    col1, col2, col3, col4 = st.columns(4)
    total_prem = df[t["premium"]].sum()
    total_cov = df[t["coverage"]].sum()
    total_med = df[t["medical_limit"]].sum() # è®¡ç®—æ€»åŒ»ç–—é™é¢
    
    with col1:
        st.metric(label=t["total_premium"], value=f"RM {total_prem:,.0f}")
    with col2:
        st.metric(label=t["total_coverage"], value=f"RM {total_cov:,.0f}")
    with col3:
        st.metric(label="Total Medical Limit", value=f"RM {total_med:,.0f}", help="æ‰€æœ‰åŒ»è¯å¡å¹´é™é¢æ€»å’Œ")
    with col4:
        st.metric(label="Policies", value=len(df))
        
    # --- è¡¨æ ¼å±•ç¤º ---
    st.subheader(t["table_header"])
    
    # å®šä¹‰åˆ—çš„æ˜¾ç¤ºæ ¼å¼
    column_config = {
        t["premium"]: st.column_config.NumberColumn(format="RM %.0f"),
        t["coverage"]: st.column_config.NumberColumn(format="RM %.0f"),
        t["medical_limit"]: st.column_config.NumberColumn(format="RM %.0f"),
        "Benefits / åˆ©ç›Š": st.column_config.TextColumn(width="medium"), # åŠ å®½è¿™ä¸€åˆ—
    }
    
    st.dataframe(
        df, 
        use_container_width=True, 
        hide_index=True,
        column_config=column_config
    )
    
    # --- å›¾è¡¨åˆ†æž ---
    st.subheader(t["chart_title"])
    
    # å‡†å¤‡å›¾è¡¨æ•°æ®ï¼šåŒ…æ‹¬ä¿è´¹ã€äººå¯¿ä¿é¢ã€åŒ»ç–—é™é¢
    chart_df = df.melt(
        id_vars=[t["policy_name"]], 
        value_vars=[t["premium"], t["coverage"], t["medical_limit"]], 
        var_name="Type", 
        value_name="Value"
    )
    
    # è¿‡æ»¤æŽ‰å€¼ä¸º0çš„æ•°æ®ï¼ˆæ¯”å¦‚æ²¡æœ‰åŒ»è¯å¡çš„ä¿å•å°±ä¸æ˜¾ç¤ºåŒ»è¯å¡æŸ±å­ï¼‰
    chart_df = chart_df[chart_df["Value"] > 0]
    
    fig = px.bar(
        chart_df, 
        x=t["policy_name"], 
        y="Value", 
        color="Type", 
        barmode="group",
        text_auto='.2s',
        # è‡ªå®šä¹‰é¢œè‰²: ä¿è´¹(çº¢), ä¿é¢(é’), åŒ»è¯å¡(è“)
        color_discrete_map={
            t["premium"]: "#FF6B6B", 
            t["coverage"]: "#4ECDC4",
            t["medical_limit"]: "#45B7D1"
        }
    )
    fig.update_layout(xaxis_title="", yaxis_title="RM")
    st.plotly_chart(fig, use_container_width=True)
    
    # --- æŒä¹…æ€§è­¦å‘Š ---
    if pd.to_numeric(df[t["sustainability"]], errors='coerce').sum() > 0:
        st.caption("âš ï¸ Sustainability Check (æŒä¹…æ€§æ£€æŸ¥)")
        sust_df = df[pd.to_numeric(df[t["sustainability"]], errors='coerce') > 0].copy()
        if not sust_df.empty:
            st.bar_chart(sust_df.set_index(t["policy_name"])[t["sustainability"]])

    # --- ä¸‹è½½åŒºåŸŸ ---
    st.markdown("---")
    csv = df.to_csv(index=False).encode('utf-8')
    file_name = f"Review_{c_name}_{datetime.now().strftime('%Y%m%d')}.csv"
    
    st.download_button(
        label=t["download_btn"],
        data=csv,
        file_name=file_name,
        mime='text/csv'
    )

st.caption(t["footer"])
